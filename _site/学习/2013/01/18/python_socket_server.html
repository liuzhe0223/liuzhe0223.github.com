<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>python_socket_server</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">liuzhe</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>python_socket_server</h2>
<p class="meta">18 Jan 2013</p>

<div class="post">
<p>做java课程设计, 做的IM, 现在回来看一下python的网络编程相关的部分先写了个基本的socket通信</p>

<p>server部分的代码如下:</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">class</span> <span class="nc">NetBase</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_thread_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="mi">8081</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;server start&quot;</span>


    <span class="k">def</span> <span class="nf">get_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">clientsock</span><span class="p">,</span> <span class="n">clientaddr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;got a client&quot;</span>
            <span class="n">thr</span> <span class="o">=</span> <span class="n">GetClient</span><span class="p">(</span><span class="n">clientsock</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_thread_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thr</span><span class="p">);</span>
            <span class="n">thr</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;start a thread&quot;</span>


<span class="k">class</span> <span class="nc">GetClient</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clientsocket</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clientsock</span> <span class="o">=</span> <span class="n">clientsocket</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">clientsock</span><span class="o">.</span><span class="n">getpeername</span><span class="p">()</span>
        <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">clientsock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">NetBase</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">get_message</span><span class="p">()</span>
</code></pre></div>

<p>需要导入网络模块socket, 为了实现多客户端的链接使用threading来实现多线程,python socket 需要指定两个参数,及地址族和套接字类型, 参数中的socket.AF<em>INET就是指定地址族,socket.AF</em>INET指的是使用ipv4协议, 后面的参数socket.SOCK<em>STREAM指定套接字类型为 面向链接的可靠字节流. server端绑定本地地址8081端口(self.sock.bind(&#39;&#39;,8081),并开始监听, get</em>message方法中 self.sock.accept() 当有客户端请求连接时得到一个server与client通信的socket, 然后把这个socket扔给自己定义的处理一客户端通信的socket的线程, 这个线程会接收来自客户端发送的消息,并将它打印出来.</p>

<p>client 端代码:</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">socket</span>

<span class="k">class</span> <span class="nc">NetBase</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">8081</span><span class="p">))</span>
        <span class="k">print</span> <span class="s">&quot;got the server&quot;</span>
    
    <span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span><span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;send the server a message,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">NetBase</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">send_message</span><span class="p">()</span>
</code></pre></div>

<p>python 还内建提供了socketserver模块,包扩很多可以可以简化socket服务器的类</p>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                Your Name<br />
                What You Are<br />
                you@example.com
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/yourusername</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
