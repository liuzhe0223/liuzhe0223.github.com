<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>django更适用于json</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">liuzhe</a></h1>
            <a class='extra' href="/">blog</a>
            <a class="extra" href="/note.html">note</a>
          </div>

          <h2>django更适用于json</h2>
<p class="meta">11 Jan 2014</p>

<div class="post">
<h1>django不合口</h1>

<p>django 是我还没认识web是什么时开始接触的一个框架，但确是我接触的python框架中唯一一个至今也没用于一个完整项目的框架，从此大概看出对于我对django的感觉, 不合口，特别是使用过rails一次之后。</p>

<p>现在接近毕业，正在实习中，现在项目中使用的正是这个&quot;姜哥&quot;, 不知觉的就会想到在rails中的一些小但很实用的东西在django中实现，并使它用的更方便一点。（以下若有错误希望高手指正)</p>

<h1>开始添加简单代码更好的使用django</h1>

<h2>需求</h2>

<p>现在需要实现的是使用django作为json输出单页应用的后端，仅这几天看文档没有发现django中有对此的比较方便的实现。扫了眼一个扩展，django-restful，对扫了眼，开始没大仔细看，现在看着还行。不过这次没有去用，看看使用我的原始方法写写我认为的rest api。</p>

<h2>处理request的json数据</h2>

<p>这个json数据也就是当使用json上传时的<code>request.body</code>里的内容, 要达到的目的是要在view中能够方便的使用<code>request.data</code>这样的方式使用上传的数据。</p>

<p>开始的想法是同时处理json请求和普通的formdata请求,所以开始直接把两种数据都放到request.POST中,所以写了一个中间件他，添加<code>process_view</code> 方法：</p>
<div class="highlight"><pre><code class="python language-python" data-lang="python"><span class="k">def</span> <span class="nf">process_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view_func</span><span class="p">,</span> <span class="n">view_args</span><span class="p">,</span> <span class="n">view_kwargs</span><span class="p">):</span>
    <span class="n">is_json</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s">&quot;CONTENT_TYPE&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span> <span class="ow">and</span> \
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;application/json&#39;</span><span class="p">:</span>
        <span class="n">is_json</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">is_json</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c">#request.POST 为django中的有序字典实现，初始换中后request.POST只读</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="bp">None</span>
</code></pre></div>
<p>后来认为使用request.POST 在后来的处理put方法给的数据时这个名字应该不太合适, 而且html的标点提交没有put方法。最后就直接只去处理json数据:</p>
<div class="highlight"><pre><code class="python language-python" data-lang="python"><span class="k">def</span> <span class="nf">process_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view_func</span><span class="p">,</span> <span class="n">view_args</span><span class="p">,</span> <span class="n">view_kwargs</span><span class="p">):</span>

    <span class="n">has_json_data</span> <span class="o">=</span> <span class="s">&#39;CONTENT_TYPE&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span> <span class="ow">and</span> \
        <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;application/json&#39;</span>

    <span class="k">if</span> <span class="n">has_json_data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                    <span class="s">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s">&#39;errors&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">&#39;json&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;json format error&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">}),</span>
                <span class="n">content_type</span><span class="o">=</span><span class="s">&quot;application/json&quot;</span>
            <span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_dict</span>

    <span class="k">return</span> <span class="bp">None</span>
</code></pre></div>
<p>这样就只处理json数据并把数据存入<code>request.data</code>中</p>

<h2>返回数据</h2>

<p>为了在view中少些写json.dumps, 就改为view function中只返回dict的数据在中间件中dump:</p>
<div class="highlight"><pre><code class="python language-python" data-lang="python"><span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">),</span>
                            <span class="n">content_type</span><span class="o">=</span><span class="s">&quot;application/json&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>
<h2>路由</h2>

<p>路由基本是类似下边：</p>
<div class="highlight"><pre><code class="python language-python" data-lang="python"><span class="p">(</span><span class="s">r&#39;^parents/(?P&lt;parent_id&gt;\d+)/chrilren/$&#39;</span><span class="p">,</span> <span class="n">childView</span><span class="p">),</span>               
<span class="p">(</span><span class="s">r&#39;^chrildren/(?P&lt;child_id&gt;\d+)/$&#39;</span><span class="p">,</span> <span class="n">childView</span><span class="p">),</span>
</code></pre></div>
<p>view 使用的普通function view, 具体操作使用的是对request.method(get, post, put, delete) 和一些参数的一块判断为何种操作进而进行操作。</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'liuzhe0223'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


          <div class="footer">
            <div class="contact">
              <p>
                Your Name<br />
                What You Are<br />
               liuzhe 
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/liuzhe0223">github.com/liuzhe0223</a><br />
                <a href="https://twitter.com/liuzhe0223">twitter.com/liuzhe0223</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
