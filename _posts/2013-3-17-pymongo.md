---
layout: post
title: pymongo的使用
tags: python
category: blog
---

mogodb是现在比较流行的非关系型数据库(不仅仅是关系型数据库), 是基于键值对的存储, 并有效的利用的内存来加快检索效率,  pymongo是python的mongodb 驱动, 今天看了一下 MongoDB and Python 这本书, 学习一下. 总体来看用pymogo 来实现对 mongodb的操作是还是比较顺手的, 像我们拿orm来操作关系型数据库, 说的只是面向对象的操作, orm的 数据对象和数据关系的映射功能, 当我们用mongodb的时候还要去实现的 不管是使用一些模块(mongoengine)还是自己实现, 毕竟我们不能在大量的代码里去找我们定义的数据模型, 放在单独的model 里才能更清晰. 不过当我们写一些小东西的时候, 直接用pymongo, 比我们用关系型数据库时写sql舒服哆啦.

下面来些笔记以备速查
连接:

```python
from pymongo import Connection
from pymongo.errors import ConnectionFailure

def main():
""" Connect to MongoDB """
try:
	conn = Connection(host="localhost", port=27017)
	print "Connected successfully"
except ConnectionFailure, e:
	sys.stderr.write("Could not connect to MongoDB: %s" % e)
```

在数据库链接成功的情况下,获取一个数据库操作对象:

```python
dbh = conn["mydb"]
```

这样即使mongodb中不存在名为mydb的数据库也不会抛出异常, 而且当你向其中存入数据时,数库会自动建一个名为mydb的数据库并将数据写入, 这样看来我们就不用专门的程序来初始化数据库啦, collection 的建立也是使用这样的方式, 像以下方式向 mydb中名为 users 的collection中插入数据:

```python
user = {
	"username" : "liuzhe",
	"tel" : "1234",
	"age" : 22,
	"schools" :{
		"highschool" : "No.1 middle school of Heze",
		"university" : "sdut"
	}
}	

dbh.users.insert(user)
```

mongodb中的查询, 当有些属性在数据中不重复时:

```python	
dbh.users.find_one({"username" : "liuzhe"})
```

find_one 在找不到符合条件的记录时返回None, 当要检索符合某一条件的多条记录时:

```python	
dbh.users.find({"age" : 22})
dbh.users.find({"age":{"$gt" : 0}})
```

上面使用 $gt 的意思是找到age比0大的记录, 类似的操作符还有
<img src="http://i.imgur.com/DNEIT1s.png" />

sort() 方法使用:

```python

dbh.users.find().sort("age", pymongo.ASCENDING)  #age的正序排列
dbh.users.find().sort("age", pymongo.DESCENDING)  #age的逆序排列

```
或者使用：

```python
dbh.users.find({"age":{"$gt": 0}}, sort=[("age", pymongo.ASENDING)])
```
使用limit()做限定:

```python
dbh.users.find().limit(20)
```
实现offset:

```python	
dbh.users.find().sort("age", pymongo.DESCENDING).limit(20).slcip(20)
```

update()的使用:

```python
dbh.users.update({"username": "liuzhe"},
				 {"$set";{"age": 18}},
				 safe=True)
```
注意使用上述方式时，如果条件匹配到多于一条的记录时，只会对搜索到的第一条记录进行修改，使用时需注意匹配条件的唯一，当要修改符合条件的多条记录时可以加上一个参数如下:

```python	
dbh.users.update({"username": "liuzhe"},
				 {"$set";{"age": 18}},
				 multi=True,
				 safe=True)
```
删除记录:

```python	
dbh.users.remove({"username": "liuzhe"})
```
使用上述方法删除记录时，如果没有符合条件的记录不会引发异常，某个collection 中所有的记录时只需把条件设为None即可，如下:

```python
dbh.users.remove(None, safe=True)
```
对嵌入的字典进行定位时(use a dot):

```python
dbh.users.find_one("schools.university": "sdut")
```
使用mongodb时我们可能会在一个document中添加很多数据， 而mongodb对单个doucument的限制大小为最大16MB，已经很大啦

建立索引:

```python
dbh.users.create_index("username")
```
	dbh.users.create_index("username", pymongo.ASCENDING)
